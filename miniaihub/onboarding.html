<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primeiros Passos | MiniIA Hub</title>
    <meta name="description" content="Configure sua conta e conecte suas ferramentas no MiniIA Hub">
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #2D9CDB;
            --color-primary-dark: #2188c2;
            --color-secondary: #27AE60;
            --color-secondary-dark: #219653;
            --color-accent: #9B51E0;
            --color-accent-dark: #8A41CC;
            --color-dark: #333333;
            --color-light: #F2F2F2;
            --color-gray: #828282;
            --color-white: #FFFFFF;
            --color-error: #EB5757;
            --color-warning: #F2994A;
            
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-weight: 400;
            color: var(--color-dark);
            background-color: var(--color-light);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 700;
            line-height: 1.2;
        }

        a {
            text-decoration: none;
            color: var(--color-primary);
        }

        /* Header */
        .header {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px 0;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo svg {
            margin-right: 10px;
        }

        .logo-text {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Main content */
        .onboarding {
            padding: 40px 0;
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .onboarding-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .onboarding-header p {
            color: var(--color-gray);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Steps */
        .steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: calc(50% - 100px);
            width: 200px;
            height: 2px;
            background-color: var(--color-light);
            z-index: 0;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            width: 120px;
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: white;
            border: 2px solid var(--color-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .step-label {
            font-size: 14px;
            color: var(--color-gray);
            text-align: center;
            transition: all 0.3s;
        }

        .step-item.active .step-number {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .step-item.active .step-label {
            color: var(--color-primary);
            font-weight: 500;
        }

        /* Step content */
        .step-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .step-content h2 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .step-content p {
            color: var(--color-gray);
            margin-bottom: 25px;
        }

        /* Search */
        .search-input {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-input input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(45, 156, 219, 0.1);
        }

        .search-input svg {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-gray);
        }

        /* Services */
        .services-container {
            margin-bottom: 30px;
        }

        .service-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .service-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .service-card.selected {
            border-color: var(--color-primary);
            background-color: rgba(45, 156, 219, 0.05);
        }

        .service-card.connected {
            border-color: var(--color-secondary);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .service-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .service-icon img {
            max-width: 100%;
            max-height: 100%;
        }

        .service-info {
            flex-grow: 1;
        }

        .service-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .service-info p {
            font-size: 14px;
            color: var(--color-gray);
            margin: 0;
        }

        .service-status {
            margin-left: 10px;
        }

        .btn-connect {
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-connect:hover {
            background-color: var(--color-primary-dark);
        }

        .status-connected {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--color-secondary);
        }

        .status-connected svg {
            margin-right: 5px;
        }

        /* Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            display: inline-block;
            font-weight: 500;
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
        }

        .btn-outline:hover {
            background-color: rgba(45, 156, 219, 0.1);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(45, 156, 219, 0.2);
        }

        /* Loading */
        .loading-container {
            text-align: center;
            padding: 30px 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(45, 156, 219, 0.2);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error */
        .error-container {
            text-align: center;
            padding: 20px;
        }

        .error-icon {
            font-size: 40px;
            color: var(--color-error);
            margin-bottom: 10px;
        }

        .error-message {
            color: var(--color-error);
            margin-bottom: 15px;
        }

        .retry-button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            cursor: pointer;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            display: flex;
            align-items: center;
            min-width: 300px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            overflow: hidden;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-content {
            flex-grow: 1;
            padding: 12px 15px;
            font-size: 14px;
        }

        .toast-close {
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--color-gray);
        }

        .toast-success {
            border-left: 4px solid var(--color-secondary);
        }

        .toast-error {
            border-left: 4px solid var(--color-error);
        }

        .toast-info {
            border-left: 4px solid var(--color-primary);
        }

        /* Debug */
        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            font-family: monospace;
        }

        .debug-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .debug-content {
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .steps {
                flex-direction: column;
                align-items: flex-start;
                margin-left: 20px;
            }
            
            .steps::before {
                display: none;
            }
            
            .step-item {
                flex-direction: row;
                width: auto;
                margin-bottom: 15px;
            }
            
            .step-number {
                margin-right: 10px;
                margin-bottom: 0;
            }
            
            .step-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .step-navigation .btn {
                width: 100%;
            }
        }
    </style>
    
    <!-- Script de inicialização -->
    <script src="/miniaihub/conectores/oauth-loader.js"></script>
    <script>
        function initOnboarding() {
            // Verificar autenticação
            if (!localStorage.getItem('miniai_session_token')) {
                window.location.href = '/miniaihub/login.html';
                return;
            }
            
            // Verificar se o email do usuário está disponível para OAuth2
            const userEmail = localStorage.getItem('miniai_user_email');
            if (userEmail && typeof oauthLoader !== 'undefined') {
                oauthLoader.setUserEmail(userEmail);
                console.log('Email do usuário carregado para OAuth2:', userEmail);
            } else {
                console.warn('Email do usuário não encontrado para OAuth2');
            }
            
            // Verificar se token está presente e garantir que será salvo
            (function() {
                try {
                    // Verificar via URL - para quando vier de redirecionamento
                    const urlParams = new URLSearchParams(window.location.search);
                    const tokenParam = urlParams.get('token');
                    
                    if (tokenParam) {
                        localStorage.setItem('miniai_token', tokenParam);
                        console.log('Token salvo a partir da URL');
                        
                        // Limpar URL
                        const cleanUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                    }
                    
                    // Verificar sessionStorage - para quando vier de cadastro/login
                    const sessionToken = sessionStorage.getItem('tokenStorage');
                    if (sessionToken && !localStorage.getItem('miniai_token')) {
                        localStorage.setItem('miniai_token', sessionToken);
                        console.log('Token salvo a partir do sessionStorage');
                    }
                    
                    // Último recurso - o token pode ter vindo no localStorage diretamente
                    const token = localStorage.getItem('miniai_token');
                    console.log('Estado do token:', token ? 'Presente' : 'Ausente');
                    
                    // REMOVER na produção - apenas para debug
                    window._debugTokenInfo = {
                        fromUrl: !!tokenParam,
                        fromSession: !!sessionToken,
                        present: !!token,
                        value: token ? token.substring(0, 10) + '...' : null
                    };
                } catch (e) {
                    console.error('Erro ao verificar token:', e);
                }
            })();
            
            // Rastrear evento
            if (typeof oauthLoader !== 'undefined') {
                oauthLoader.trackEvent('Onboarding Started', { 
                    hasEmail: !!localStorage.getItem('miniai_user_email'),
                    hasToken: !!localStorage.getItem('miniai_token') 
                });
            }
            
            // Carregar serviços
            loadServices();
            
            // Configurar event listeners
            setupEventListeners();
        }
    </script>
</head>
<body onload="initOnboarding()">
    <!-- Header -->
    <header class="header">
        <div class="container header-container">
            <a href="/" class="logo">
                <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 3C9.716 3 3 9.716 3 18C3 26.284 9.716 33 18 33C26.284 33 33 26.284 33 18C33 9.716 26.284 3 18 3Z" fill="#2D9CDB"/>
                    <path d="M24 13L16 21L12 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 25L10 21L14 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 9L26 13L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="logo-text">MiniIA Hub</span>
            </a>
            
            <button id="toggle-debug" style="padding: 5px 10px; font-size: 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">Debug</button>
        </div>
    </header>

    <!-- Onboarding -->
    <section class="onboarding">
        <div class="container">
            <div class="onboarding-header">
                <h1>Vamos configurar sua conta</h1>
                <p>Configure suas ferramentas para automatizar seus fluxos de trabalho.</p>
            </div>
            
            <!-- Steps -->
            <div class="steps">
                <div class="step-item active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Conectar ferramentas</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Instalar Mini-IA</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Confirmar</div>
                </div>
            </div>
            
            <!-- Debug Panel (escondido inicialmente) -->
            <div id="debug-panel" class="debug-panel" style="display: none;">
                <div class="debug-title">Informações de Debug</div>
                <div id="debug-content" class="debug-content">Carregando informações...</div>
            </div>
            
            <!-- Step 1: Conectar Ferramentas -->
            <div class="step-content" id="step-1">
                <h2>Conecte suas ferramentas</h2>
                <p>Escolha quais ferramentas você deseja conectar para automatizar seus fluxos de trabalho.</p>
                
                <div class="search-input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input type="text" id="service-search" placeholder="Buscar ferramentas...">
                </div>
                
                <!-- Serviços -->
                <div id="services-container" class="services-container">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Carregando serviços...</p>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <a href="/" class="btn btn-outline">Cancelar</a>
                    <button id="next-button" class="btn btn-primary">Próximo passo</button>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script>
        // Estado global da aplicação
        const app = {
            selectedServiceId: null,
            connectedServices: [],
            authManager: null,
            debug: false,
            mainToken: localStorage.getItem('miniai_token'),
            currentStep: 1
        };
        
        // Configurar painel de debug
        function setupDebugPanel() {
            const debugToggle = document.getElementById('toggle-debug');
            const debugPanel = document.getElementById('debug-panel');
            const debugContent = document.getElementById('debug-content');
            
            debugToggle.addEventListener('click', function() {
                app.debug = !app.debug;
                debugPanel.style.display = app.debug ? 'block' : 'none';
                
                if (app.debug) {
                    updateDebugInfo();
                }
            });
            function updateDebugInfo() {
            const info = {
                location: window.location.href,
                token: app.mainToken ? `${app.mainToken.substring(0, 10)}...` : 'Não encontrado',
                tokenInfo: window._debugTokenInfo || 'Não disponível',
                userEmail: localStorage.getItem('miniai_user_email'),
                connectedServices: app.connectedServices,
                currentStep: app.currentStep,
                localStorage: listLocalStorage()
            };
            
            debugContent.textContent = JSON.stringify(info, null, 2);
        }
        
        function listLocalStorage() {
            const items = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    items[key] = localStorage.getItem(key);
                    if (key.includes('token')) {
                        items[key] = items[key].substring(0, 10) + '...';
                    }
                } catch (e) {
                    items[key] = '[erro ao acessar]';
                }
            }
            return items;
        }
        
        // Atualizar a cada 3 segundos se estiver visível
        setInterval(() => {
            if (app.debug && document.getElementById('debug-panel').style.display === 'block') {
                updateDebugInfo();
            }
        }, 3000);
    }
    
    // Configurar event listeners
    function setupEventListeners() {
        // Botão de próximo passo
        document.getElementById('next-button').addEventListener('click', goToNextStep);
        
        // Campo de busca
        document.getElementById('service-search').addEventListener('input', filterServices);
        
        // Verificar estado de depuração
        setupDebugPanel();
        
        // Salvar passo atual no sessionStorage
        saveCurrentStep();
    }
    
    // Carregar serviços disponíveis
    async function loadServices() {
        const container = document.getElementById('services-container');
        
        try {
            // Tentar usar oauthLoader se disponível
            let services = [];
            
            if (typeof oauthLoader !== 'undefined') {
                try {
                    services = await oauthLoader.getAvailableServices();
                    console.log(`${services.length} serviços carregados via oauthLoader`);
                } catch (error) {
                    console.error('Erro ao carregar serviços via oauthLoader:', error);
                    showToast('Erro ao carregar serviços. Tentando novamente...', 'error');
                    
                    // Implementar retry com exponential backoff
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    services = await oauthLoader.getAvailableServices();
                }
            } else {
                // Usar authManager como fallback
                if (!app.authManager) {
                    console.warn('oauthLoader e authManager não disponíveis, usando dados de exemplo');
                    services = getExampleServices();
                } else {
                    services = await app.authManager.getServices();
                }
            }
            
            // Limpar container
            container.innerHTML = '';
            
            if (services.length === 0) {
                container.innerHTML = '<p style="text-align:center">Nenhum serviço disponível no momento.</p>';
                return;
            }
            
            // Registrar evento de analytics
            if (typeof oauthLoader !== 'undefined') {
                oauthLoader.trackEvent('Services Loaded', { count: services.length });
            }
            
            // Renderizar cada serviço
            services.forEach(service => {
                const isConnected = typeof oauthLoader !== 'undefined' 
                    ? oauthLoader.isAuthenticated(service.id)
                    : (app.authManager ? app.authManager.isAuthenticated(service.id) : false);
                
                if (isConnected && !app.connectedServices.includes(service.id)) {
                    app.connectedServices.push(service.id);
                }
                
                const card = document.createElement('div');
                card.className = `service-card${isConnected ? ' connected' : ''}`;
                card.dataset.serviceId = service.id;
                
                card.innerHTML = `
                    <div class="service-icon">
                        <img src="${service.icon}" alt="${service.name}" onerror="this.src='/miniaihub/assets/img/service-default.png'">
                    </div>
                    <div class="service-info">
                        <h3>${service.name}</h3>
                        <p>${service.description}</p>
                    </div>
                    <div class="service-status">
                        ${isConnected ? 
                            `<div class="status-connected">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18457 2.99721 7.13633 4.39828 5.49707C5.79935 3.85782 7.69279 2.71538 9.79619 2.24015C11.8996 1.76491 14.1003 1.98234 16.07 2.86" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Conectado
                            </div>` : 
                            '<button class="btn-connect">Conectar</button>'}
                    </div>
                `;
                
                // Adicionar ao container
                container.appendChild(card);
                
                // Adicionar evento aos botões de conectar
                const connectButton = card.querySelector('.btn-connect');
                if (connectButton) {
                    connectButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // Evitar que o clique do botão propague para o card
                        connectService(service.id, service.name);
                    });
                }
                
                // Adicionar evento de seleção ao card
                card.addEventListener('click', () => {
                    // Só permitir selecionar se não estiver conectado
                    if (!isConnected) {
                        selectService(service.id);
                    }
                });
            });
            
            showToast('Serviços carregados com sucesso', 'success');
            updateNextButtonState();
        } catch (error) {
            console.error('Erro ao carregar serviços:', error);
            
            container.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">⚠️</div>
                    <p class="error-message">Erro ao carregar serviços</p>
                    <button class="retry-button">Tentar novamente</button>
                </div>
            `;
            
            container.querySelector('.retry-button').addEventListener('click', loadServices);
            
            showToast('Erro ao carregar serviços', 'error');
        }
    }
    
    // Dados de exemplo para quando não há API disponível
    function getExampleServices() {
        return [
            {
                id: "gmail",
                name: "Gmail",
                icon: "https://www.gstatic.com/images/branding/product/1x/gmail_48dp.png",
                description: "Serviço de e-mail do Google"
            },
            {
                id: "google-sheets",
                name: "Google Sheets",
                icon: "https://www.gstatic.com/images/branding/product/1x/sheets_48dp.png",
                description: "Planilhas online do Google"
            },
            {
                id: "google-drive",
                name: "Google Drive",
                icon: "https://www.gstatic.com/images/branding/product/1x/drive_48dp.png",
                description: "Armazenamento em nuvem do Google"
            },
            {
                id: "trello",
                name: "Trello",
                icon: "/miniaihub/assets/img/trello-icon.png",
                description: "Gerenciamento de projetos e tarefas"
            }
        ];
    }
    
    // Selecionar serviço
    function selectService(serviceId) {
        // Atualizar estado
        app.selectedServiceId = serviceId;
        
        // Atualizar UI
        document.querySelectorAll('.service-card').forEach(card => {
            // Só adicionar seleção se não estiver conectado
            if (!card.classList.contains('connected')) {
                card.classList.toggle('selected', card.dataset.serviceId === serviceId);
            }
        });
    }
    
    // Conectar serviço
    async function connectService(serviceId, serviceName) {
        const card = document.querySelector(`[data-service-id="${serviceId}"]`);
        const statusElement = card.querySelector('.service-status');
        
        // Mostrar loading
        statusElement.innerHTML = `
            <button class="btn-connect" disabled>
                <span class="loading-spinner" style="width: 16px; height: 16px; display: inline-block; margin-right: 5px; vertical-align: middle;"></span>
                Conectando...
            </button>
        `;
        
        try {
            let success = false;
            
            // Tentar usar oauthLoader
            if (typeof oauthLoader !== 'undefined') {
                try {
                    // Verificar se email está disponível
                    const userEmail = oauthLoader.getUserEmail();
                    if (!userEmail) {
                        console.warn('Email do usuário não encontrado para OAuth2. O fluxo pode falhar.');
                        showToast('Aviso: Email não configurado. A autenticação pode falhar.', 'warning');
                    }
                    
                    // Iniciar autenticação OAuth2
                    success = await oauthLoader.startOAuth2Flow(serviceId);
                } catch (error) {
                    console.error('Erro na autenticação via oauthLoader:', error);
                    throw error;
                }
            } else if (app.authManager) {
                // Fallback para authManager
                success = await app.authManager.authenticateService(serviceId);
            } else {
                // Mock para testes
                await new Promise(resolve => setTimeout(resolve, 1500));
                success = true;
                console.log('Autenticação simulada concluída:', serviceId);
            }
            
            if (success) {
                // Atualizar UI
                card.classList.add('connected');
                statusElement.innerHTML = `
                    <div class="status-connected">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18457 2.99721 7.13633 4.39828 5.49707C5.79935 3.85782 7.69279 2.71538 9.79619 2.24015C11.8996 1.76491 14.1003 1.98234 16.07 2.86" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Conectado
                    </div>
                `;
                
                // Atualizar estado
                if (!app.connectedServices.includes(serviceId)) {
                    app.connectedServices.push(serviceId);
                }
                
                // Rastrear evento
                if (typeof oauthLoader !== 'undefined') {
                    oauthLoader.trackEvent('OAuth Success', { 
                        serviceId, 
                        serviceName,
                        userEmail: oauthLoader.getUserEmail() 
                    });
                }
                
                showToast(`Serviço ${serviceName || serviceId} conectado com sucesso`, 'success');
                updateNextButtonState();
            } else {
                // Restaurar botão
                statusElement.innerHTML = '<button class="btn-connect">Conectar</button>';
                
                // Readicionar evento
                statusElement.querySelector('.btn-connect').addEventListener('click', () => {
                    connectService(serviceId, serviceName);
                });
                
                // Rastrear evento
                if (typeof oauthLoader !== 'undefined') {
                    oauthLoader.trackEvent('OAuth Canceled', { 
                        serviceId, 
                        serviceName 
                    });
                }
                
                showToast(`Autenticação cancelada para ${serviceName || serviceId}`, 'info');
            }
        } catch (error) {
            console.error('Erro na autenticação:', error);
            
            // Restaurar botão
            statusElement.innerHTML = '<button class="btn-connect">Conectar</button>';
            
            // Readicionar evento
            statusElement.querySelector('.btn-connect').addEventListener('click', () => {
                connectService(serviceId, serviceName);
            });
            
            // Rastrear evento
            if (typeof oauthLoader !== 'undefined') {
                oauthLoader.trackEvent('OAuth Error', { 
                    serviceId, 
                    serviceName,
                    error: error.message 
                });
            }
            
            showToast(`Erro ao conectar ${serviceName || serviceId}`, 'error');
        }
    }
    
    // Filtrar serviços
    function filterServices() {
        const searchText = document.getElementById('service-search').value.toLowerCase();
        const cards = document.querySelectorAll('.service-card');
        
        cards.forEach(card => {
            const name = card.querySelector('h3').textContent.toLowerCase();
            const description = card.querySelector('p').textContent.toLowerCase();
            
            if (name.includes(searchText) || description.includes(searchText)) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    // Atualizar estado do botão Próximo
    function updateNextButtonState() {
        const nextButton = document.getElementById('next-button');
        
        // Habilitar o botão apenas se pelo menos um serviço estiver conectado
        nextButton.disabled = app.connectedServices.length === 0;
        
        if (app.connectedServices.length === 0) {
            nextButton.style.opacity = '0.6';
            nextButton.style.cursor = 'not-allowed';
        } else {
            nextButton.style.opacity = '1';
            nextButton.style.cursor = 'pointer';
        }
    }
    
    // Salvar passo atual no sessionStorage
    function saveCurrentStep() {
        try {
            sessionStorage.setItem('miniai_onboarding_step', app.currentStep.toString());
            
            // Rastrear evento
            if (typeof oauthLoader !== 'undefined') {
                oauthLoader.trackEvent('Onboarding Step', { step: app.currentStep });
            }
        } catch (e) {
            console.error('Erro ao salvar passo atual:', e);
        }
    }
    
    // Ir para o próximo passo
    function goToNextStep() {
        if (app.connectedServices.length === 0) {
            showToast('Conecte pelo menos um serviço para continuar', 'error');
            return;
        }
        
        // Atualizar passo atual
        app.currentStep++;
        saveCurrentStep();
        
        // Por enquanto, redirecionar para o dashboard
        // Em uma implementação completa, mostraríamos a próxima etapa do onboarding
        window.location.href = '/miniaihub/dashboard.html';
    }
    
    // Exibir erro
    function showError(message) {
        const container = document.getElementById('services-container');
        
        container.innerHTML = `
            <div class="error-container">
                <div class="error-icon">⚠️</div>
                <p class="error-message">${message}</p>
                <a href="/miniaihub/login.html" class="retry-button">Fazer login</a>
            </div>
        `;
        
        showToast(message, 'error');
    }
    
    // Mostrar toast notification
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">${message}</div>
            <button class="toast-close">&times;</button>
        `;
        
        container.appendChild(toast);
        
        // Mostrar toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Auto close
        const closeTimeout = setTimeout(() => {
            closeToast(toast);
        }, 5000);
        
        // Botão de fechar
        toast.querySelector('.toast-close').addEventListener('click', () => {
            clearTimeout(closeTimeout);
            closeToast(toast);
        });
    }
    
    // Fechar toast
    function closeToast(toast) {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }
</script>
</body>
</html>
