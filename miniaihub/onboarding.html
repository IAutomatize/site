<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primeiros Passos | MiniIA Hub</title>
    <meta name="description" content="Configure sua conta e conecte suas ferramentas no MiniIA Hub">
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Cores principais */
            --color-primary: #2D9CDB;
            --color-primary-light: #56CCF2;
            --color-primary-dark: #2188c2;
            --color-secondary: #27AE60;
            --color-secondary-light: #6FCF97;
            --color-secondary-dark: #219653;
            --color-accent: #9B51E0;
            --color-accent-dark: #8A41CC;
            --color-dark: #333333;
            --color-light: #F2F2F2;
            --color-gray: #828282;
            --color-white: #FFFFFF;
            --color-error: #EB5757;
            --color-warning: #F2994A;
            
            /* Fontes */
            --font-heading: 'Poppins', sans-serif;
            --font-body: 'Inter', sans-serif;
            
            /* Espaçamentos */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Bordas */
            --border-radius-sm: 4px; 
            --border-radius-md: 8px;
            --border-radius-lg: 16px;
            
            /* Sombras */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            
            /* Transições */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
        }

        /* Reset e base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-weight: 400;
            color: var(--color-dark);
            background-color: var(--color-light);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: var(--spacing-md);
        }

        a {
            text-decoration: none;
            color: var(--color-primary);
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--color-primary-dark);
        }

        button {
            font-family: var(--font-body);
            cursor: pointer;
            border: none;
            background: none;
        }

        /* Header */
        .header {
            background-color: var(--color-white);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .logo svg {
            margin-right: var(--spacing-sm);
        }

        .logo-text {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: var(--spacing-xl) 0;
            position: relative;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: calc(25% + 25px);
            right: calc(25% + 25px);
            height: 2px;
            background-color: var(--color-light);
            z-index: 0;
        }

        .progress-line-active {
            position: absolute;
            top: 50%;
            left: calc(25% + 25px);
            width: 0%;
            height: 2px;
            background-color: var(--color-primary);
            z-index: 1;
            transition: width var(--transition-normal);
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            width: 140px;
            transition: all var(--transition-normal);
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--color-white);
            border: 2px solid var(--color-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            transition: all var(--transition-normal);
            color: var(--color-gray);
        }

        .step-label {
            font-size: 14px;
            color: var(--color-gray);
            text-align: center;
            transition: all var(--transition-normal);
        }

        .step.active .step-circle {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-white);
            transform: scale(1.05);
        }

        .step.active .step-label {
            color: var(--color-primary);
            font-weight: 500;
        }

        .step.completed .step-circle {
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
            color: var(--color-white);
        }

        .step.completed .step-label {
            color: var(--color-secondary);
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: var(--spacing-lg) 0 var(--spacing-xl);
        }

        .content-card {
            background-color: var(--color-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .content-header {
            margin-bottom: var(--spacing-lg);
        }

        .content-header h2 {
            font-size: 24px;
            margin-bottom: var(--spacing-xs);
        }

        .content-header p {
            color: var(--color-gray);
        }

        /* Search Input */
        .search-input {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .search-input input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid #E0E0E0;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            transition: all var(--transition-fast);
        }

        .search-input input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(45, 156, 219, 0.2);
        }

        .search-input svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-gray);
        }

        /* Services */
        .services-container {
            margin-bottom: var(--spacing-lg);
        }

        .service-card {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            border: 1px solid #E0E0E0;
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-normal);
            background-color: var(--color-white);
        }

        .service-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .service-card.connected {
            border-color: var(--color-secondary);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .service-icon {
            width: 50px;
            height: 50px;
            margin-right: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .service-icon img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .service-info {
            flex-grow: 1;
        }

        .service-info h3 {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .service-info p {
            font-size: 14px;
            color: var(--color-gray);
            margin: 0;
        }

        .service-status {
            margin-left: var(--spacing-md);
        }

        /* Botão conectar */
        .btn-connect {
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
        }

        .btn-connect:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-1px);
        }

        .btn-connect:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
            transform: none;
        }

        /* Status conectado */
        .status-connected {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--color-secondary);
            font-weight: 500;
        }

        .status-connected svg {
            margin-right: 5px;
        }

        /* Ver mais */
        .more-services-container {
            display: none;
            margin-top: var(--spacing-md);
        }

        .btn-more {
            display: block;
            width: 100%;
            text-align: center;
            padding: var(--spacing-md);
            color: var(--color-primary);
            font-weight: 500;
            border: 1px dashed #E0E0E0;
            border-radius: var(--border-radius-md);
            background-color: transparent;
            margin-top: var(--spacing-sm);
            transition: all var(--transition-fast);
        }

        .btn-more:hover {
            background-color: rgba(45, 156, 219, 0.05);
            border-color: var(--color-primary-light);
        }

        /* Navegação entre passos */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-xl);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 16px;
            padding: 12px 24px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 120px;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
        }

        .btn-outline:hover {
            background-color: rgba(45, 156, 219, 0.1);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-white);
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .loading-container {
            text-align: center;
            padding: var(--spacing-xl) 0;
        }

        .loading-container .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(45, 156, 219, 0.2);
            border-top-color: var(--color-primary);
            margin-bottom: var(--spacing-md);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 450px;
            background-color: white;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            margin-bottom: 10px;
            overflow: hidden;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            flex-shrink: 0;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--spacing-sm);
        }

        .toast-content {
            flex-grow: 1;
            padding: 12px 0;
            font-size: 14px;
        }

        .toast-close {
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--color-gray);
            opacity: 0.7;
            transition: opacity var(--transition-fast);
        }

        .toast-close:hover {
            opacity: 1;
        }

        .toast-success {
            border-left: 4px solid var(--color-secondary);
        }

        .toast-success .toast-icon {
            color: var(--color-secondary);
        }

        .toast-error {
            border-left: 4px solid var(--color-error);
        }

        .toast-error .toast-icon {
            color: var(--color-error);
        }

        .toast-info {
            border-left: 4px solid var(--color-primary);
        }

        .toast-info .toast-icon {
            color: var(--color-primary);
        }

        .toast-warning {
            border-left: 4px solid var(--color-warning);
        }

        .toast-warning .toast-icon {
            color: var(--color-warning);
        }

        /* Error */
        .error-container {
            text-align: center;
            padding: var(--spacing-xl) 0;
        }

        .error-icon {
            font-size: 40px;
            color: var(--color-error);
            margin-bottom: var(--spacing-md);
        }

        .error-message {
            color: var(--color-error);
            margin-bottom: var(--spacing-lg);
            font-weight: 500;
        }

        .retry-button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .retry-button:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* Empty state */
        .empty-container {
            text-align: center;
            padding: var(--spacing-xl) 0;
        }

        .empty-icon {
            font-size: 40px;
            color: var(--color-gray);
            margin-bottom: var(--spacing-md);
        }

        .empty-message {
            color: var(--color-gray);
            margin-bottom: var(--spacing-lg);
        }

        /* Debug Panel */
        .debug-panel {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background-color: #f5f5f5;
            border-radius: var(--border-radius-md);
            font-family: monospace;
            font-size: 12px;
            display: none;
        }

        .debug-title {
            font-weight: bold;
            margin-bottom: var(--spacing-sm);
        }

        .debug-content {
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .progress-steps {
                flex-direction: column;
                align-items: flex-start;
                margin-left: var(--spacing-md);
                margin-top: var(--spacing-md);
                margin-bottom: var(--spacing-xl);
            }
            
            .progress-line, .progress-line-active {
                display: none;
            }
            
            .step {
                flex-direction: row;
                width: auto;
                margin-bottom: var(--spacing-md);
                align-items: center;
            }
            
            .step-circle {
                margin-right: var(--spacing-md);
                margin-bottom: 0;
                width: 40px;
                height: 40px;
            }
            
            .step-navigation {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .step-navigation .btn {
                width: 100%;
            }
            
            .content-card {
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 480px) {
            .service-card {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .service-icon {
                margin-bottom: var(--spacing-sm);
            }
            
            .service-status {
                margin-left: 0;
                margin-top: var(--spacing-sm);
                width: 100%;
            }
            
            .btn-connect {
                width: 100%;
            }
            
            .status-connected {
                width: 100%;
                justify-content: center;
                padding: var(--spacing-xs) 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-container">
            <a href="/" class="logo">
                <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 3C9.716 3 3 9.716 3 18C3 26.284 9.716 33 18 33C26.284 33 33 26.284 33 18C33 9.716 26.284 3 18 3Z" fill="#2D9CDB"/>
                    <path d="M24 13L16 21L12 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 25L10 21L14 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 9L26 13L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="logo-text">MiniIA Hub</span>
            </a>
            
            <div class="header-controls">
                <button id="toggle-debug" style="padding: 4px 8px; font-size: 12px; color: #777; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9;">Debug</button>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="container">
        <div class="progress-steps">
            <div class="progress-line"></div>
            <div class="progress-line-active" style="width: 0%;"></div>
            
            <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Conectar ferramentas</div>
            </div>
            
            <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Instalar Mini-IA</div>
            </div>
            
            <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Confirmar</div>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <div class="container">
        <div id="debug-panel" class="debug-panel">
            <div class="debug-title">Informações de Debug</div>
            <div id="debug-content" class="debug-content">Carregando informações...</div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Step 1: Conectar Ferramentas -->
            <div class="content-card" id="step-1">
                <div class="content-header">
                    <h2>Conecte suas ferramentas</h2>
                    <p>Escolha quais ferramentas você deseja conectar para automatizar seus fluxos de trabalho.</p>
                </div>
                
                <div class="search-input">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 21L16.65 16.65M19 11C19 15.4183 15.4183 19 11 19C6.58172 19 3 15.4183 3 11C3 6.58172 6.58172 3 11 3C15.4183 3 19 6.58172 19 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input type="text" id="service-search" placeholder="Buscar ferramentas...">
                </div>
                
                <!-- Serviços -->
                <div id="services-container" class="services-container">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Carregando serviços...</p>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <a href="/" class="btn btn-outline">Cancelar</a>
                    <button id="next-button" class="btn btn-primary" disabled>Próximo passo</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Script para OAuth Loader -->
    <script src="/miniaihub/conectores/oauth-loader.js"></script>
    
    <!-- Scripts -->
    <script>
        // Estado global da aplicação
        const app = {
            // Informações de estado
            currentStep: 1,
            maxStep: 3,
            connectedServices: [],
            selectedServiceId: null,
            searchTerm: '',
            
            // Flags e configurações
            debug: false,
            initialized: false,
            
            // Dados persistidos
            userEmail: localStorage.getItem('miniai_user_email'),
            sessionToken: localStorage.getItem('miniai_session_token'),
            mainToken: localStorage.getItem('miniai_token')
        };
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar autenticação
            checkAuthentication();
            
            // Verificar inicialização de OAuth
            listenForOAuthLoader();
            
            // Configurar interface
            setupUI();
            
            // Ativar depuração (opcional)
            setupDebugPanel();
        });
        
        // Verificar se o usuário está autenticado
        function checkAuthentication() {
            if (!app.sessionToken && !app.mainToken) {
                console.error('Erro: Token de autenticação não encontrado');
                window.location.href = '/miniaihub/login.html';
                return false;
            }
            
            if (!app.userEmail) {
                console.warn('Alerta: Email do usuário não encontrado. Fluxo OAuth pode ser comprometido.');
                showToast('Email não encontrado. Recomendamos fazer login novamente.', 'warning');
            } else {
                console.log(`Usuário autenticado: ${app.userEmail}`);
            }
            
            return true;
        }
        
        // Aguardar carregamento do OAuth Loader
        function listenForOAuthLoader() {
            // Verificar se já está disponível
            if (typeof oauthLoader !== 'undefined') {
                console.log('OAuth Loader já disponível');
                initializeWithOAuth();
                return;
            }
            
            // Aguardar evento de carregamento
            document.addEventListener('oauth-loader-ready', () => {
                console.log('OAuth Loader carregado com sucesso');
                initializeWithOAuth();
            });
            
            // Timeout para fallback se não carregar
            setTimeout(() => {
                if (typeof oauthLoader === 'undefined' && !app.initialized) {
                    console.warn('OAuth Loader não foi carregado após 5 segundos. Usando fallback.');
                    initializeWithoutOAuth();
                }
            }, 5000);
        }
        
        // Inicializar com OAuth
        function initializeWithOAuth() {
            if (app.initialized) return;
            app.initialized = true;
            
            // Configurar email no oauth-loader
            if (app.userEmail && typeof oauthLoader !== 'undefined') {
                oauthLoader.setUserEmail(app.userEmail);
                console.log(`Email "${app.userEmail}" configurado para fluxos OAuth2`);
            }
            
            // Carregar serviços
            loadServices();
            
            // Registrar evento de Analytics (opcional)
            if (typeof oauthLoader !== 'undefined') {
                oauthLoader.trackEvent && oauthLoader.trackEvent('Onboarding Started', { 
                    hasEmail: !!app.userEmail,
                    hasToken: !!(app.sessionToken || app.mainToken)
                });
            }
        }
        
        // Inicializar sem OAuth (fallback)
        function initializeWithoutOAuth() {
            if (app.initialized) return;
            app.initialized = true;
            
            console.warn('Inicializando sem OAuth Loader. Algumas funcionalidades podem não funcionar.');
            showToast('Aviso: Componentes necessários não carregados. Funcionalidade limitada.', 'warning');
            
            // Carregar serviços de exemplo
            loadServices(true); // true = usar fallback
        }
        
        // Configurar Interface do Usuário
        function setupUI() {
            // Campo de busca
            document.getElementById('service-search').addEventListener('input', (e) => {
                app.searchTerm = e.target.value.toLowerCase();
                filterServices();
            });
            
            // Botão "Próximo"
            const nextButton = document.getElementById('next-button');
            nextButton.addEventListener('click', goToNextStep);
            
            // Restaurar progresso de onboarding (se houver)
            restoreProgress();
        }
        
        // Restaurar progresso salvo
        function restoreProgress() {
            try {
                const savedStep = parseInt(sessionStorage.getItem('miniai_onboarding_step')) || 1;
                if (savedStep > 1 && savedStep <= app.maxStep) {
                    app.currentStep = savedStep;
                    updateProgressSteps();
                    // Aqui você poderia carregar o conteúdo do passo atual
                }
            } catch (e) {
                console.error('Erro ao restaurar progresso:', e);
            }
        }
        
        // Atualizar indicadores de progresso
        function updateProgressSteps() {
            // Atualizar classes das etapas
            document.querySelectorAll('.step').forEach(step => {
                const stepNumber = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                
                if (stepNumber === app.currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < app.currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Atualizar linha de progresso
            const progressWidth = ((app.currentStep - 1) / (app.maxStep - 1)) * 100;
            document.querySelector('.progress-line-active').style.width = `${progressWidth}%`;
            
            // Salvar progresso atual
            try {
                sessionStorage.setItem('miniai_onboarding_step', app.currentStep.toString());
            } catch (e) {
                console.warn('Erro ao salvar progresso:', e);
            }
        }
        
        // Salvar serviços conectados
        function saveConnectedServices() {
            try {
                localStorage.setItem('miniai_connected_services', JSON.stringify(app.connectedServices));
            } catch (e) {
                console.warn('Erro ao salvar serviços conectados:', e);
            }
        }
        
        // Carregar serviços disponíveis
        async function loadServices(useFallback = false) {
            const container = document.getElementById('services-container');
            
            try {
                // Mostrar loading
                container.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Carregando serviços...</p>
                    </div>
                `;
                
                // Carregando serviços
                let services;
                
                if (useFallback) {
                    // Usar dados de exemplo se necessário
                    services = getFallbackServices();
                } else {
                    try {
                        // Carregar via oauthLoader
                        if (typeof oauthLoader !== 'undefined' && oauthLoader.getAvailableServices) {
                            services = await oauthLoader.getAvailableServices();
                            console.log(`${services.length} serviços carregados via API`);
                        } else {
                            throw new Error('OAuth loader não disponível');
                        }
                    } catch (apiError) {
                        console.warn('Erro ao carregar serviços via API, usando fallback:', apiError);
                        services = getFallbackServices();
                    }
                }
                
                // Verificar serviços carregados
                if (!services || !Array.isArray(services) || services.length === 0) {
                    container.innerHTML = `
                        <div class="empty-container">
                            <div class="empty-icon">🔍</div>
                            <p class="empty-message">Nenhum serviço disponível no momento.</p>
                        </div>
                    `;
                    return;
                }
                
                // Limpar container
                container.innerHTML = '';
                
                // Processar serviços em lotes para otimização
                const visibleServices = services.slice(0, 4);
                const hiddenServices = services.slice(4);
                
                // Renderizar serviços visíveis
                visibleServices.forEach(service => renderServiceCard(service, container));
                
                // Serviços adicionais (se houver)
                if (hiddenServices.length > 0) {
                    // Container para serviços "ver mais"
                    const moreContainer = document.createElement('div');
                    moreContainer.className = 'more-services-container';
                    moreContainer.id = 'more-services-container';
                    
                    // Renderizar serviços adicionais
                    hiddenServices.forEach(service => renderServiceCard(service, moreContainer));
                    
                    // Botão "Ver mais"
                    const moreButton = document.createElement('button');
                    moreButton.className = 'btn-more';
                    moreButton.id = 'btn-more';
                    moreButton.textContent = 'Ver mais serviços';
                    moreButton.addEventListener('click', toggleMoreServices);
                    
                    // Adicionar ao DOM
                    container.appendChild(moreContainer);
                    container.appendChild(moreButton);
                }
                
                // Verificar estado de botões
                updateNextButtonState();
                
                // Executar filtragem inicial se houver termo de busca
                if (app.searchTerm) {
                    filterServices();
                }
            } catch (error) {
                console.error('Erro ao carregar serviços:', error);
                
                container.innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">⚠️</div>
                        <p class="error-message">Erro ao carregar serviços: ${error.message}</p>
                        <button class="retry-button" onclick="loadServices()">Tentar novamente</button>
                    </div>
                `;
                
                showToast('Erro ao carregar serviços. Tente novamente.', 'error');
            }
        }
        
        // Renderizar card de serviço
        function renderServiceCard(service, container) {
            // Verificar autenticação do serviço
            let isConnected = false;
            
            if (typeof oauthLoader !== 'undefined' && oauthLoader.isAuthenticated) {
                // Verificar via oauthLoader
                isConnected = oauthLoader.isAuthenticated(service.id);
            } else {
                // Verificar via estado local
                isConnected = app.connectedServices.includes(service.id);
            }
            
            // Atualizar lista de serviços conectados
            if (isConnected && !app.connectedServices.includes(service.id)) {
                app.connectedServices.push(service.id);
                saveConnectedServices();
            }
            
            // Criar elemento de card
            const card = document.createElement('div');
            card.className = `service-card${isConnected ? ' connected' : ''}`;
            card.dataset.serviceId = service.id;
            
            // HTML do card
            card.innerHTML = `
                <div class="service-icon">
                    <img src="${service.icon || '/miniaihub/assets/img/service-default.png'}" 
                         alt="${service.name}" 
                         onerror="this.src='/miniaihub/assets/img/service-default.png'">
                </div>
                
                <div class="service-info">
                    <h3>${service.name}</h3>
                    <p>${service.description || 'Serviço para automação de fluxos'}</p>
                </div>
                
                <div class="service-status">
                    ${isConnected ? 
                        `<div class="status-connected">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18457 2.99721 7.13633 4.39828 5.49707C5.79935 3.85782 7.69279 2.71538 9.79619 2.24015C11.8996 1.76491 14.1003 1.98234 16.07 2.86" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Conectado
                        </div>` : 
                        '<button class="btn-connect">Conectar</button>'}
                </div>
            `;
            
            // Adicionar ao container
            container.appendChild(card);
            
            // Adicionar evento ao botão de conectar
            if (!isConnected) {
                const connectButton = card.querySelector('.btn-connect');
                if (connectButton) {
                    connectButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // Evitar que o clique propague para o card
                        connectService(service.id, service.name);
                    });
                }
            }
        }
        
        // Conectar serviço
        async function connectService(serviceId, serviceName) {
            console.log(`Iniciando conexão com serviço: ${serviceId}`);
            
            // Encontrar card do serviço
            const card = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (!card) {
                console.error(`Card não encontrado para serviço: ${serviceId}`);
                return;
            }
            
            // Elemento de status
            const statusElement = card.querySelector('.service-status');
            
            // Mostrar loading
            statusElement.innerHTML = `
                <button class="btn-connect" disabled>
                    <span class="loading-spinner"></span>
                    Conectando...
                </button>
            `;
            
            try {
                // Verificar disponibilidade do OAuth Loader
                if (typeof oauthLoader === 'undefined') {
                    throw new Error('Sistema de autenticação não disponível');
                }
                
                // Verificar email do usuário
                if (!app.userEmail) {
                    console.warn('Email do usuário não configurado para OAuth2');
                    showToast('Aviso: Email não configurado. Autenticação pode falhar.', 'warning');
                }
                
                // Iniciar fluxo OAuth2
                console.log(`Iniciando fluxo OAuth2 para ${serviceId}`);
                
                const oauthResult = await oauthLoader.startOAuth2Flow(serviceId);
                console.log(`Resultado OAuth para ${serviceId}:`, oauthResult);
                
                if (oauthResult === true) {
                    // Sucesso - atualizar UI
                    card.classList.add('connected');
                    statusElement.innerHTML = `
                        <div class="status-connected">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18457 2.99721 7.13633 4.39828 5.49707C5.79935 3.85782 7.69279 2.71538 9.79619 2.24015C11.8996 1.76491 14.1003 1.98234 16.07 2.86" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Conectado
                        </div>
                    `;
                    
                    // Adicionar à lista de serviços conectados
                    if (!app.connectedServices.includes(serviceId)) {
                        app.connectedServices.push(serviceId);
                        saveConnectedServices();
                    }
                    
                    // Atualizar estado do botão de próximo passo
                    updateNextButtonState();
                    
                    // Mostrar notificação
                    showToast(`Serviço ${serviceName} conectado com sucesso!`, 'success');
                } else {
                    // Falha ou cancelamento
                    statusElement.innerHTML = '<button class="btn-connect">Conectar</button>';
                    
                    // Readicionar evento ao botão
                    const newButton = statusElement.querySelector('.btn-connect');
                    if (newButton) {
                        newButton.addEventListener('click', () => {
                            connectService(serviceId, serviceName);
                        });
                    }
                    
                    showToast(`A conexão com ${serviceName} foi cancelada.`, 'info');
                }
            } catch (error) {
                console.error(`Erro ao conectar serviço ${serviceId}:`, error);
                
                // Restaurar botão
                statusElement.innerHTML = '<button class="btn-connect">Conectar</button>';
                
                // Readicionar evento
                const newButton = statusElement.querySelector('.btn-connect');
                if (newButton) {
                    newButton.addEventListener('click', () => {
                        connectService(serviceId, serviceName);
                    });
                }
                
                // Mostrar erro
                showToast(`Erro ao conectar ${serviceName}: ${error.message}`, 'error');
            }
        }
        
        // Alternar visibilidade dos serviços adicionais
        function toggleMoreServices() {
            const container = document.getElementById('more-services-container');
            const button = document.getElementById('btn-more');
            
            if (!container || !button) return;
            
            const isVisible = container.style.display === 'block';
            
            // Alternar visibilidade
            container.style.display = isVisible ? 'none' : 'block';
            
            // Atualizar texto do botão
            button.textContent = isVisible ? 'Ver mais serviços' : 'Ver menos serviços';
        }
        
        // Filtrar serviços por termo de busca
        function filterServices() {
            const searchTerm = app.searchTerm.toLowerCase();
            const allCards = document.querySelectorAll('.service-card');
            
            // Se não houver termo de busca, mostrar todos
            if (!searchTerm) {
                allCards.forEach(card => {
                    card.style.display = 'flex';
                });
                return;
            }
            
            // Filtrar por nome e descrição
            let foundCount = 0;
            
            allCards.forEach(card => {
                const name = card.querySelector('h3').textContent.toLowerCase();
                const description = card.querySelector('p').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = 'flex';
                    foundCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Mostrar "Ver mais" se houver resultados ocultos
            const moreContainer = document.getElementById('more-services-container');
            const moreButton = document.getElementById('btn-more');
            
            if (moreContainer && moreButton) {
                // Verificar se há cards ocultos na busca
                const hiddenCards = Array.from(moreContainer.querySelectorAll('.service-card'))
                    .filter(card => card.style.display !== 'none');
                
                if (searchTerm && hiddenCards.length > 0) {
                    // Mostrar container e atualizar botão
                    moreContainer.style.display = 'block';
                    moreButton.textContent = 'Ver menos serviços';
                } else if (!searchTerm) {
                    // Comportamento padrão quando não há busca
                    moreContainer.style.display = 'none';
                    moreButton.textContent = 'Ver mais serviços';
                    moreButton.style.display = 'block';
                } else {
                    // Esconder botão se não houver resultados
                    moreButton.style.display = 'none';
                }
            }
            
            // Se não encontrar nenhum, mostrar mensagem
            if (foundCount === 0) {
                const servicesContainer = document.getElementById('services-container');
                
                // Verificar se já existe mensagem de "não encontrado"
                let emptyMessage = servicesContainer.querySelector('.empty-search');
                
                if (!emptyMessage) {
                    emptyMessage = document.createElement('div');
                    emptyMessage.className = 'empty-container empty-search';
                    emptyMessage.innerHTML = `
                        <div class="empty-icon">🔍</div>
                        <p class="empty-message">Nenhum serviço encontrado para "${searchTerm}"</p>
                        <button class="btn btn-outline" onclick="clearSearch()">Limpar busca</button>
                    `;
                    servicesContainer.appendChild(emptyMessage);
                } else {
                    // Atualizar mensagem existente
                    const messageText = emptyMessage.querySelector('.empty-message');
                    if (messageText) {
                        messageText.textContent = `Nenhum serviço encontrado para "${searchTerm}"`;
                    }
                    emptyMessage.style.display = 'block';
                }
                
                // Esconder botão "Ver mais"
                if (moreButton) {
                    moreButton.style.display = 'none';
                }
            } else {
                // Esconder mensagem de "não encontrado" se existir
                const emptyMessage = document.querySelector('.empty-search');
                if (emptyMessage) {
                    emptyMessage.style.display = 'none';
                }
            }
        }
        
        // Limpar busca
        function clearSearch() {
            const searchInput = document.getElementById('service-search');
            if (searchInput) {
                searchInput.value = '';
                app.searchTerm = '';
                filterServices();
            }
        }
        
        // Atualizar estado do botão "Próximo passo"
        function updateNextButtonState() {
            const nextButton = document.getElementById('next-button');
            if (!nextButton) return;
            
            // Habilitar apenas se houver serviços conectados
            const hasConnected = app.connectedServices.length > 0;
            nextButton.disabled = !hasConnected;
            
            // Feedback visual
            if (hasConnected) {
                nextButton.style.opacity = '1';
                nextButton.style.cursor = 'pointer';
            } else {
                nextButton.style.opacity = '0.6';
                nextButton.style.cursor = 'not-allowed';
            }
        }
        
        // Ir para o próximo passo
        function goToNextStep() {
            // Verificar se há serviços conectados
            if (app.connectedServices.length === 0) {
                showToast('Conecte pelo menos um serviço para continuar', 'error');
                return;
            }
            
            // Registrar evento de analytics
            if (typeof oauthLoader !== 'undefined' && oauthLoader.trackEvent) {
                oauthLoader.trackEvent('Onboarding Next Step', { 
                    step: app.currentStep,
                    connectedServices: app.connectedServices
                });
            }
            
            // Incrementar passo atual
            app.currentStep++;
            
            // Atualizar UI
            updateProgressSteps();
            
            // Para esta versão simplificada, redirecionar para o dashboard
            // Em uma implementação completa, mostraríamos o próximo passo do onboarding
            window.location.href = '/miniaihub/dashboard.html';
        }
        
        // Mostrar notificação toast
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            
            // Criar elemento toast
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Ícone de acordo com o tipo
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18457 2.99721 7.13633 4.39828 5.49707C5.79935 3.85782 7.69279 2.71538 9.79619 2.24015C11.8996 1.76491 14.1003 1.98234 16.07 2.86" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    break;
                case 'error':
                    icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9V13M12 17H12.01M5.07183 19H18.9282C20.4678 19 21.4301 17.3333 20.6603 16L13.7321 4C12.9623 2.66667 11.0378 2.66667 10.268 4L3.33978 16C2.56998 17.3333 3.53223 19 5.07183 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    break;
                case 'info':
                    icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    break;
                case 'warning':
                    icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9V13M12 17H12.01M21.73 18L13.73 4C13.5556 3.6922 13.3057 3.4329 13.0042 3.25061C12.7028 3.06833 12.3599 2.97021 12.01 2.97021C11.6601 2.97021 11.3172 3.06833 11.0158 3.25061C10.7143 3.4329 10.4645 3.6922 10.29 4L2.29 18C2.1055 18.304 2.00054 18.6509 2 19.005C1.99946 19.3591 2.1034 19.7063 2.28701 20.0108C2.47062 20.3153 2.73097 20.5672 3.04082 20.7404C3.35068 20.9137 3.70049 21.0015 4.055 21H19.955C20.3102 21.0025 20.6608 20.9155 20.9716 20.7428C21.2824 20.5701 21.5436 20.3185 21.7279 20.0139C21.9121 19.7094 22.0165 19.3619 22.0163 19.0075C22.016 18.6531 21.9111 18.3057 21.7265 18.0015L21.73 18Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    break;
            }
            
            // Estrutura interna do toast
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">${message}</div>
                <button class="toast-close">&times;</button>
            `;
            
            // Adicionar ao container
            container.appendChild(toast);
            
            // Mostrar com animação
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Configurar fechamento automático
            const closeTimeout = setTimeout(() => {
                closeToast(toast);
            }, 5000);
            
            // Botão de fechar
            const closeButton = toast.querySelector('.toast-close');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    clearTimeout(closeTimeout);
                    closeToast(toast);
                });
            }
        }
        
        // Fechar toast
        function closeToast(toast) {
            toast.classList.remove('show');
            
            // Remover após animação
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
        
        // Configurar painel de debug
        function setupDebugPanel() {
            const debugToggle = document.getElementById('toggle-debug');
            const debugPanel = document.getElementById('debug-panel');
            const debugContent = document.getElementById('debug-content');
            
            if (!debugToggle || !debugPanel || !debugContent) return;
            
            // Alternar visibilidade
            debugToggle.addEventListener('click', () => {
                app.debug = !app.debug;
                debugPanel.style.display = app.debug ? 'block' : 'none';
                
                if (app.debug) {
                    updateDebugContent();
                }
            });
            
            // Função para atualizar conteúdo
            function updateDebugContent() {
                const debugInfo = {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    time: new Date().toISOString(),
                    appState: {
                        currentStep: app.currentStep,
                        connectedServices: app.connectedServices,
                        userEmail: app.userEmail ? `${app.userEmail.substring(0, 3)}...` : null,
                        hasToken: !!app.mainToken || !!app.sessionToken
                    },
                    oauthLoaderAvailable: typeof oauthLoader !== 'undefined',
                    localStorage: getLocalStorageKeys(),
                    sessionStorage: getSessionStorageKeys()
                };
                
                debugContent.textContent = JSON.stringify(debugInfo, null, 2);
            }
            
            // Obter chaves do localStorage (seguro)
            function getLocalStorageKeys() {
                const keys = {};
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        
                        // Mascarar valores sensíveis
                        if (key.includes('token') || key.includes('auth')) {
                            keys[key] = value ? `${value.substring(0, 5)}...` : null;
                        } else {
                            keys[key] = value;
                        }
                    }
                } catch (e) {
                    return { error: e.message };
                }
                return keys;
            }
            
            // Obter chaves do sessionStorage (seguro)
            function getSessionStorageKeys() {
                const keys = {};
                try {
                    for (let i = 0; i < sessionStorage.length; i++) {
                        const key = sessionStorage.key(i);
                        const value = sessionStorage.getItem(key);
                        
                        // Mascarar valores sensíveis
                        if (key.includes('token') || key.includes('auth')) {
                            keys[key] = value ? `${value.substring(0, 5)}...` : null;
                        } else {
                            keys[key] = value;
                        }
                    }
                } catch (e) {
                    return { error: e.message };
                }
                return keys;
            }
            
            // Atualizar a cada 3 segundos quando visível
            setInterval(() => {
                if (app.debug && debugPanel.style.display === 'block') {
                    updateDebugContent();
                }
            }, 3000);
        }
        
        // Serviços fallback para quando a API falha
        function getFallbackServices() {
            return [
                {
                    id: "gmail",
                    name: "Gmail",
                    icon: "https://www.gstatic.com/images/branding/product/1x/gmail_48dp.png",
                    description: "Serviço de e-mail do Google"
                },
                {
                    id: "google-sheets",
                    name: "Google Sheets",
                    icon: "https://www.gstatic.com/images/branding/product/1x/sheets_48dp.png",
                    description: "Planilhas online do Google"
                },
                {
                    id: "google-drive",
                    name: "Google Drive",
                    icon: "https://www.gstatic.com/images/branding/product/1x/drive_48dp.png",
                    description: "Armazenamento em nuvem do Google"
                },
                {
                    id: "google-calendar",
                    name: "Google Calendar",
                    icon: "https://www.gstatic.com/images/branding/product/1x/calendar_48dp.png",
                    description: "Calendário e agenda online do Google"
                },
                {
                    id: "trello",
                    name: "Trello",
                    icon: "https://d2k1ftgv7pobq7.cloudfront.net/meta/p/res/images/spirit/product/0ecc64d7338fab9d64e0e708b4d53d5a/trello.svg",
                    description: "Gerenciamento de projetos e tarefas"
                },
                {
                    id: "slack",
                    name: "Slack",
                    icon: "https://a.slack-edge.com/80588/marketing/img/meta/slack_hash_128.png",
                    description: "Plataforma de comunicação para equipes"
                },
                {
                    id: "dropbox",
                    name: "Dropbox",
                    icon: "https://cfl.dropboxstatic.com/static/images/logo_catalog/dropbox_logo_glyph_2015_m1.svg",
                    description: "Armazenamento e compartilhamento de arquivos"
                },
                {
                    id: "notion",
                    name: "Notion",
                    icon: "https://www.notion.so/front-static/shared/icons/notion-app-icon-3d.png",
                    description: "Espaço de trabalho tudo-em-um para notas e documentação"
                }
            ];
        }
    </script>
</body>
</html>
